<link rel="stylesheet" href="/styles/MH_LapThanhToanGiaHan.css">

<div class="extension-container">
  {{> header showBreadcrumb=true breadcrumbText="Lập thanh toán phiếu gia hạn"}}

  <div class="content-wrapper">
    <h1 class="page-title">Lập thanh toán phiếu gia hạn</h1>

    <div class="search-section">
      <form action="/tim-kiem-phieu-gia-han" method="POST" class="search-form">
        <input type="text" name="tuKhoa" placeholder="Nhập mã phiếu gia hạn" value="{{tuKhoa}}" class="search-input">
        <button type="submit" class="search-button">
          <i class="fa-solid fa-magnifying-glass"></i>
        </button>
      </form>
    </div>

    <div class="table-container">
      <table class="candidates-table">
        <thead>
          <tr>
            <th>Mã phiếu gia hạn</th>
            <th>Phí gia hạn</th>
            <th>Trường hợp gia hạn</th>
          </tr>
        </thead>
        <tbody>
          {{#each danhSachPhieuGiaHan}}
          <tr>
            <td>{{this.MAPHIEUGIAHAN}}</td>
            <td>{{this.PHIGIAHAN}}</td>
            <td>{{this.TRUONGHOPGIAHAN}}</td>
          </tr>
          {{/each}}
        </tbody>
      </table>
    </div>

    <div class="form-extension">
      <h2>Thông tin thanh toán</h2>
      <form id="formThanhToanGiaHan">
        <input type="hidden" name="maPhieuGiaHan" id="maPhieuGiaHanInput">

        <div class="form-group">
          <label for="trangThai">Trạng thái thanh toán:</label>
          <select name="trangThai" id="trangThai" required>
            <option value="">-- Chọn trạng thái --</option>
            <option value="Đã thanh toán">Đã thanh toán</option>
            <option value="Chưa thanh toán">Chưa thanh toán</option>
            <option value="Quá hạn">Quá hạn</option>
          </select>
        </div>

        <div class="form-group">
          <label for="soTien">Số tiền thanh toán (VNĐ):</label>
          <input type="number" name="soTien" id="soTien" required>
        </div>

        <div class="form-group">
          <label for="ngayThanhToan">Ngày thanh toán:</label>
          <input type="date" name="ngayThanhToan" id="ngayThanhToan" required>
        </div>

        <button type="submit" class="btn-create" id="btnLapThanhToanGiaHan">
          <i class="fa-solid fa-file-circle-plus"></i> Lập thanh toán gia hạn
        </button>
      </form>

      <div id="thongBaoKetQua" style="margin-top: 20px;"></div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    class MH_LapThanhToanGiaHan {
      constructor() {
        this.selectedRow = null;
        this.init();
      }

      init() {
        this.handleRowSelection();
        this.handleFormSubmit();
      }

      handleRowSelection() {
        const rows = document.querySelectorAll(".candidates-table tbody tr");
        rows.forEach(row => {
          row.addEventListener("click", () => {
            if (this.selectedRow) {
              this.selectedRow.classList.remove("selected");
            }
            row.classList.add("selected");
            this.selectedRow = row;

            document.getElementById("maPhieuGiaHanInput").value = row.cells[0].textContent.trim();
          });
        });
      }

      handleFormSubmit() {
        const form = document.getElementById("formThanhToanGiaHan");
        form.addEventListener("submit", async (event) => {
          event.preventDefault();

          const formData = new FormData(form);
          const data = Object.fromEntries(formData.entries());

          try {
            const res = await fetch("/lap-thanh-toan-gia-han", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data)
            });

            const result = await res.json();
            if (result.success) {
              document.getElementById("thongBaoKetQua").innerHTML = 
                `<div class="alert alert-success">${result.message}</div>`;
            } else {
              document.getElementById("thongBaoKetQua").innerHTML = 
                `<div class="alert alert-danger">${result.message}</div>`;
            }
          } catch (error) {
            console.error('Lỗi khi tạo thanh toán gia hạn:', error);
            document.getElementById("thongBaoKetQua").innerHTML = 
              `<div class="alert alert-danger">Đã xảy ra lỗi khi tạo thanh toán gia hạn</div>`;
          }
        });
      }
    }

    new MH_LapThanhToanGiaHan();
  });
</script>
